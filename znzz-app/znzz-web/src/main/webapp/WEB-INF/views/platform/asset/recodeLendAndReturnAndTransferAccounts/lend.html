<div class="modal-dialog" style="width: 1210px;">
	<div class="modal-content">

		<form class="form-horizontal" id="lendForm" method="post"
			data-parsley-validate action="${base}/asset/recode/addLendRecode">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"
					aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title" id="myModalLabel">资产借出</h4>
			</div>
			<div class="modal-body">
				<div class="box-body">
					<input type="hidden" id="assetCodeArray" value="${obj.assetCodeArray}"/>
					<input type="hidden" name="showObj" value="${obj}"/>
					<div class="row">
						<!-- /.col -->
						<div class="col-md-12">
							<!-- Date -->
							<div class="form-group">
								<label class="col-sm-1 control-label text-center">统一编号</label>
								<div class="col-sm-7">
									<input type="text" id="add_asset_code_lend" name="assetCode"
										style="width: 270px;" class="form-control"
										data-parsley-required="true" autofocus="autofocus"
										placeholder="请输入统一编号">
								</div>
								<div class="col-sm-1 col-md-offset-2"
									style="padding-left: 102px;">
									<a href="javascript:void(0);" id="del" onclick="del()"
										class="btn btn-default pull-left" style="width: 90px;">批量删除</a>
								</div>
								<!-- /.input group -->
							</div>
						</div>

						<div class="col-md-12" style="width: 1200px; margin-bottom: 10px;">

							<table id="unittable_return1" style="width: 1180px;"
								class="table table-bordered table-hover">
								<thead>
									<tr>
										<th>统一编号</th>
										<th>资产名称</th>
										<th>出厂编号</th>
										<th>型号</th>
										<th>规格</th>
										<!-- 	<th >归还日期</th>
										<th >归还人</th> -->
										<!-- <th >操作</th> -->
									</tr>
								</thead>
							</table>

						</div>

						<div class="col-md-5">
							<div class="form-group">
								<label class="col-sm-3 control-label" style="width: 30.3%">使用单位</label>

								<div class="col-sm-8">
									<!--  <select class="form-control select2" name="applyDepart" id="add_apply_depart" data-placeholder="请选择"style="width: 100%;" data-tags="true"  data-allow-clear="true"	>
                                               
                                            </select> -->
									<input type="text" name="applyDepart" id="add_apply_depart"
										placeholder="请选择" style="width: 100%;">

								</div>
							</div>
						</div>

						<div class="col-md-4">
							<div class="form-group">
								<label class="col-sm-3 control-label" for="worker">使用人</label>

								<div class="col-sm-9">
									<input type="text" name="applyPerson" id="add_apply_person"
										placeholder="请选择" style="width: 100%;">
									<!-- <select class="form-control select2" name="applyPerson" id="add_apply_person" data-placeholder="请选择" style="width: 100%;"data-tags="true"  data-allow-clear="true"	>
                                         </select> -->
								</div>
							</div>
						</div>


						<div class="col-md-5">
							<div class="form-group">
								<label class="col-sm-4 control-label" style="width: 30.3%">办理单位</label>

								<div class="col-sm-8">
									<input type="text" id="add_original_depart"
										name="originalDepart" class="form-control"
										data-parsley-required="true" style="width: 100%;"
										placeholder="请输入受理单位" value="${obj.unit.name!}">
								</div>
							</div>
						</div>

						<div class="col-md-4" style="text-align: center">
							<div class="form-group">
								<label class="col-sm-3 control-label" for="worker">办理人</label>

								<div class="col-sm-9">
									<input type="text" id="add_handle_person" name="handlePerson"
										value="${obj.username!}" style="width: 100%;"
										class="form-control" data-parsley-required="true"
										placeholder="请输入办理人">
								</div>
							</div>
						</div>

						<div class="col-md-5">
							<div class="form-group">
								<label class="col-sm-4 control-label" for="recordTime_lend"
									style="width: 30.3%">借出时间</label>

								<div class="col-sm-8">
									<div class="input-group date">
										<div class="input-group-addon">
											<i class="fa fa-calendar"></i>
										</div>
										<input type="text" class="form-control pull-right"
											name="oprateTime" id="recordTime_lend">

									</div>
								</div>
							</div>
						</div>
						<div class="col-md-4" style="text-align: center">
							<div class="form-group">
								<label class="col-sm-3 control-label" for="fujian">附件</label>

								<div class="col-sm-9">
									<input type="text" id="fujian" name="str1"  style="width: 100%;"
										   class="form-control" data-parsley-required="true"
										   placeholder="请输入附件">
								</div>
							</div>
						</div>

						<div class="col-md-12">
							<div class="form-group">
								<label
									style="width: 10.2%; margin-left: -9px; padding: 10px 5px 5px 70px;"
									class="col-sm-1 control-label" for="worker">备注</label>
								<div class="col-sm-8" style="padding: 10px 5px 5px 53px;">
									<textarea class="form-control" name="remark" rows="3"
										style="width: 97%; resize: none"></textarea>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="form-group" hidden="true">

								<div class="col-sm-8">

									<input type="text" class="form-control pull-right"
										id="code_return_list_lend" hidden="true"
										name="code_return_list_lend">

								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="form-group" hidden="true">
								<label class="col-sm-4 control-label" for="person">类型</label>
								<div class="col-sm-8">
									<input type="text" class="form-control pull-right" value="0"
										hidden="true" name="actionType" id="add_action_type">

								</div>
							</div>
						</div>
					</div>

				</div>


			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" onclick="formreset()"
					data-dismiss="modal" style="width: 120px">关闭</button>
				<button class="btn btn-primary" onclick="addListCode1()"
					data-loading-text="正在提交..." style="width: 120px">确定</button>
			</div>

		</form>

	</div>
</div>



<script>

var datatable_lend;
function initDatatable() {
	datatable_lend = $('#unittable_return1').DataTable({
        "dom": '<"toolbar">frtip',
        "searching": false,
        "processing": false,
        "serverSide": false,
        "paging": false,
        "select": false,
        "ordering": false, 
        "destroy":true,
       
        "sScrollY":"200px",
        "language": {
            "url": "${base}/assets/plugins/datatables/cn.json"
        },
        
        "preDrawCallback": function () {
            sublime.showLoadingbar($(".main-content"));           
        },
        "drawCallback": function (settings) {
            sublime.closeLoadingbar($(".main-content"));           
        },
         
        "ajax": {
            "url": "${base}/asset/recode/showReturnIndex",
            "type": "post",
            "data": function (d) {        
            	d.assetCode = $('#add_asset_code_lend').val().trim();
            	d.assetCodeArray = $('#assetCodeArray').val().trim();

            }
        },
//        "order": [[0, "desc"]],
        "columns": [
                 {"data": "assetCode", "bSortable": true},
                {"data": "assetName", "bSortable": true},
                {"data": "serialNumber", "bSortable": true},
                {"data": "deviceVersion", "bSortable": true},
                {"data": "ggName", "bSortable": true}

              
        ],
        "columnDefs": [
                  
       				{
       					 "render": function (data, type, row) {
       						 if(data == null || "" == data) {return "--"}else {return data};
       					 },
       					  "targets": [0,1,2,3,4]
       				}
       				
              ]
        
    });
    
    /* 点击选中 */
  datatable_lend.on('click', 'tr', function () {
	        $(this).toggleClass('selected');
	    });  

}

        //批量赋值仪器编码
		function addListCode1(){
			  var  code_return_arr=[] ;
			  $("#unittable_return1").find("tr").each(function () {
			  var assetCode_check = $(this).children('td:eq(0)').text();
			  code_return_arr.push(assetCode_check)
			  document.getElementById("code_return_list_lend").value = code_return_arr;
			});
			  
			  $('#lendForm').ajaxForm({
			       dataType: 'json',
			       beforeSubmit: function (arr, form, options) {
			    		console.log(arr);
			    	   if($("#code_return_list_lend").val()==",表中数据为空"||$("#code_return_list_lend").val()==""){
				    		Toast.error("借出设备不能为空");
				    		return false;
				    	}
				    	if($("#add_apply_depart").val().trim()==""){
				    		Toast.error("使用单位不能为空");
				    		return false;
				    	}

				    	/*if($("#add_apply_person").val().trim()==""){
				    		Toast.error("使用人不能为空");
				    		return false;
				    	}*/

				    	if($("#add_original_depart").val().trim()==""){
				    		Toast.error("办理单位不能为空");
				    		return false;
				    	}
				    	if($("#add_handle_person").val().trim()==""){
				    		Toast.error("办理人不能为空");
				    		return false;
				    	}
			        	if($("#recordTime_lend").val().trim()==""){
				    		Toast.error("时间不能为空");
				    		return false;
				    	}
				    
			           form.find("button:submit").button("loading");
			        },
			       success: function (data, statusText, xhr, form) {
			            if (data.code == 0) {
			                Toast.success(data.msg);
			                //清空table
			            	//document.getElementById("lendForm").reset(); 
			             	//var table = document.getElementById("unittable_return1"); 
			      			//table.innerHTML ="";
			      			//$("#add_asset_code_lend").val("");
			      			//document.getElementById('barcon1').innerHTML = "";
			               // $("#recode_modal").modal('hide');
			               //刷新父级菜单
			                datatable.ajax.reload();
			                setTimeout(function () {
			                    $("#goback").trigger("click");
			                }, 500);
			            } else {
			                Toast.error(data.msg);
			            }
			            form.find("button:submit").button("reset");
			            $("#homeDetail").modal('hide');
			            
			        }
			    });	  
		}
		
		//清空form以及表单
        function formreset(){
        	 document.getElementById("lendForm").reset(); 
       	     var table = document.getElementById("unittable_return1"); 
			 table.innerHTML ="";
			 $("#add_asset_code_lend").val("");
			// document.getElementById('barcon1').innerHTML = "";
        }
        var table ;
    
   	    //回车表格增加一行时间
   	    $('#add_asset_code_lend').keydown(function(e){
			if(e.keyCode==13){
				var assetCode =	$("#add_asset_code_lend").val().trim();
				$.ajax({
      			  type:"post",
      			  data: {assetCode:assetCode},
      			  dataType:"json",
      			  url:"${base}/asset/recode/showLendRecode",
      			  success:function(data){
      				  var flag =1 ;
      				  if(null!=data&&data!=""){
      				      if(data.actionType == -1){
      				    	  if(data.assetType == 1){
	                              Toast.warning("编号为"+data.assetCode+"的设备没有在库房当中");
      				    	  }
      				    	  if(data.assetType == 2){
	                              Toast.warning("编号为"+data.assetCode+"的仪器没有在库房当中");
     				    	  }
      				    	  if(data.assetType == 3){
	                              Toast.warning("编号为"+data.assetCode+"的工量具没有在库房当中");
     				    	  }
                          }else if(data.actionType== 0){
      						  if(data.assetType == 1){
	                              Toast.warning("编号为"+data.assetCode+"的设备已经借出"); 
     				    	  }
     				    	  if(data.assetType == 2){
     				    		 Toast.warning("编号为"+data.assetCode+"的仪器已经借出");
    				    	  }
     				    	  if(data.assetType == 3){
     				    		 Toast.warning("编号为"+data.assetCode+"的工量具已经借出");
    				    	  }
      					  }else if (data.actionType== 10){
      					  	  Toast.warning("编号为"+data.assetCode+"的资产等待报废,不允许借出操作");
      					  } else if (data.actionType== 11){
      						  Toast.warning("编号为"+data.assetCode+"的资产已被报废,不允许借出操作");
      					  } else if (data.actionType== 12){
      						  Toast.warning("编号为"+data.assetCode+"的资产已被封存,不允许借出操作"); 
      					  } else if (data.actionType != -1 && data.actionType != 11 && data.actionType != 10 && data.actionType != 0){
      						  $("#unittable_return1").find("tr").each(function () {
      							　　//第二列单元格的值eq(索引)
      							  var assetCode_check = $(this).children('td:eq(0)').text();
      							  var assetCode_checked = data.assetCode;
      							  //alert(assetCode_check+"0"+assetCode_checked);
      							  if(assetCode_checked==assetCode_check){
      								  flag = 0;
      								  return false;
      							  }
      							});
      						  if(flag==1){
      							    table = $('#unittable_return1').DataTable();
      					   		 
		        							table.row.add( {
										        "assetCode":  data.assetCode,
										        "assetName":  data.assetName,
										        "serialNumber":  data.serialNumber,
										        "deviceVersion":  data.deviceVersion,
										        "ggName":   data.ggName
										
										    } ).draw();
		        							$("#add_asset_code_lend").val("");	
      						  }
      					  }
      					  
      					
      				  }else{
      					  Toast.warning("不存在此编号仪器或编号为空！");
      				  }
      			  }
      			});
			}
			});
   	    

   	 $("#add_asset_code_lend").blur(function(){
   		 
   		var assetCode =	$("#add_asset_code_lend").val().trim();
   		
   		if(assetCode==""||assetCode==null){
   			
   		}else{
   			$.ajax({
  			  type:"post",
  			  data: {assetCode:assetCode},
  			  dataType:"json",
  			  url:"${base}/asset/recode/showLendRecode",
  			  success:function(data){
  				  var flag =1 ;
  				  if(null!=data&&data!=""){
  					console.log(data.actionType);
  				      if(data.actionType == -1){
                          if(data.assetType == 1){
                              Toast.warning("编号为"+data.assetCode+"的设备没有在库房当中");
  				    	  }
  				    	  if(data.assetType == 2){
                              Toast.warning("编号为"+data.assetCode+"的仪器没有在库房当中");
 				    	  }
  				    	  if(data.assetType == 3){
                              Toast.warning("编号为"+data.assetCode+"的工量具没有在库房当中");
 				    	  }
					  }else if(data.actionType== 0){
  						  if(data.assetType == 1){
                            Toast.warning("编号为"+data.assetCode+"的设备已经借出"); 
				    	  }
				    	  if(data.assetType == 2){
				    		 Toast.warning("编号为"+data.assetCode+"的仪器已经借出");
				    	  }
				    	  if(data.assetType == 3){
				    		 Toast.warning("编号为"+data.assetCode+"的工量具已经借出");
				    	  }
  					  } else if (data.actionType== 10){
  					  	  Toast.warning("编号为"+data.assetCode+"的资产等待报废,不允许借出操作");
  					  } else if (data.actionType== 11){
  						  Toast.warning("编号为"+data.assetCode+"的资产已被报废,不允许借出操作");
  					  } else if (data.actionType== 12){
  						  Toast.warning("编号为"+data.assetCode+"的资产已被封存,不允许借出操作"); 
  					  } else if (data.actionType != -1 && data.actionType != 11 && data.actionType != 10 && data.actionType != 0){
  						  $("#unittable_return1").find("tr").each(function () {
  							　　//第二列单元格的值eq(索引)
  							  var assetCode_check = $(this).children('td:eq(0)').text();
  							  var assetCode_checked = data.assetCode;
  							  //alert(assetCode_check+"0"+assetCode_checked);
  							  if(assetCode_checked==assetCode_check){
  								  flag = 0;
  								  return false;
  							  }
  							});
  						  if(flag==1){
  							    table = $('#unittable_return1').DataTable();
  					   		 
          							table.row.add( {
  								        "assetCode":  data.assetCode,
  								        "assetName":  data.assetName,
  								        "serialNumber":  data.serialNumber,
  								        "deviceVersion":  data.deviceVersion,
  								        "ggName":   data.ggName
  								
  								    } ).draw();
          							$("#add_asset_code_lend").val("");	
  						  }
  					  } 
  					  
  					
  				  }else{
  					  Toast.warning("不存在此编号仪器或编号为空！");
  				  }
  			  }
  			});	
   		}
		
   		 
   	 }); 
   	    
   	  
       

</script>
<script language="JavaScript">

//取消点击确定，默认回车事件
$(document).keydown(function(event){
    switch(event.keyCode){
       case 13:return false; 
       }
});
$(document).ready(function () {  

	  setTimeout(function () { 
		  
		  initDatatable();
		  $("#add_asset_code_lend").focus();  
	    }, 200);
	
	  loadUnitAndUserNoKuFang("add_apply_depart","add_apply_person");
	//设置时间
    setDate("recordTime_lend");
	//初始化默认时间
    $('#recordTime_lend').val((new Date()).format("yyyy-MM-dd"));
});

function del(){

    datatable_lend.rows('.selected').remove().draw();
}





</script>