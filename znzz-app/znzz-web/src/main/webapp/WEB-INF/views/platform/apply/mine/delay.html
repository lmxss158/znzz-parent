<%
layout("/layouts/platform.html"){
%>
<link type="text/css" rel="stylesheet" href="${base!}/assets/sen/css/mobile_date.css">
<script type="text/javascript" src="${base!}/assets/sen/js/mobile_date.js"></script>
<script type="text/javascript" src="${base!}/assets/sen/js/apply_utils.js"></script>
<div>
    <section class="content-header">
        <a href="${base!}/asset/apply/mine" data-pjax>
            <button type="button" class="close">
                <span aria-hidden="true">x</span>
            </button>
        </a>
        <h4>延期申请</h4>
    </section>
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box box-info">
                    <div class="box-body">
                        <form id="applyDelayModal" role="form" class="form-horizontal parsley-form" data-parsley-validate
                              action="${base}/asset/apply/mine/doDelay" method="post" data-backdrop="static"
                              data-keyboard="false">
                            <div role="form" class="form-horizontal parsley-form" data-parsley-validate>
                                <div class="panel panel-primary">
                                    <div class="panel-heading" role="tab" id="headingOne">
                                        <h4 class="panel-title">
                                            <a role="button" data-toggle="collapse" data-parent="#accordion"
                                               href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                资产信息
                                            </a>
                                        </h4>
                                    </div>
                                    <div id="one" class="panel-collapse" role="tabpanel"
                                         aria-labelledby="headingFour">
                                        <div class="panel-body">
                                            <div class="form-group">
                                                <label for="assetCode" class="col-sm-1 control-label">统一编号：</label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="assetCode"
                                                           value="${obj.assetCode}"
                                                           disabled>
                                                    <input type="hidden" name="assetCode" value="${obj.assetCode}">
                                                </div>

                                                <label for="assetName" class="col-sm-1 control-label">资产名称：</label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="assetName"
                                                           value="${obj.assetName}"
                                                           disabled>
                                                    <input type="hidden" name="assetName" value="${obj.assetName}">
                                                </div>
                                                <label for="deviceVersion" class="col-sm-1 control-label">资产型号：</label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="deviceVersion"
                                                           value="${obj.deviceVersion}" disabled>
                                                    <input type="hidden" name="deviceVersion"
                                                           value="${obj.deviceVersion}">
                                                </div>
                                                <label for="serialNumber" class="col-sm-1 control-label">出厂编号：</label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="serialNumber"
                                                           value="${obj.serialNumber}" disabled>
                                                    <input type="hidden" name="serialNumber"
                                                           value="${obj.serialNumber}">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="enableTime" class="col-sm-1 control-label">启用日期：</label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="enableTime"
                                                           name="enableTime"
                                                           value="${@date.formatDate(obj.enableTime)}" disabled>
                                                </div>

                                                <label for="powerOffTime" class="col-sm-1 control-label">离线日期：</label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="powerOffTime"
                                                           name="powerOffTime"
                                                           value="${@date.formatDate(obj.powerOffTime)}" disabled>
                                                </div>
                                                <label for="ggName" class="col-sm-1 control-label">规格：</label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="ggName"
                                                           value="${obj.ggName}"
                                                           disabled>
                                                    <input type="hidden" name="specifications" value="${obj.ggName}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="panel panel-primary">
                                    <div class="panel-heading" role="tab" id="headingTwo">
                                        <h4 class="panel-title">
                                            <a role="button" data-toggle="collapse" data-parent="#accordion"
                                               href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                延期信息
                                            </a>
                                        </h4>
                                    </div>
                                    <div id="two" class="panel-collapse" role="tabpanel"
                                         aria-labelledby="headingFour">
                                        <div class="panel-body">
                                            <div class="form-group">
                                                <label for="applyId" class="col-sm-1 control-label">申请编号：</label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="applyId"
                                                           value="${obj.applyId}"
                                                           disabled>
                                                    <input type="hidden" name="applyId" value="${obj.applyId}">
                                                </div>

                                                <label for="proposer" class="col-sm-1 control-label">申请人：</label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="proposer"
                                                           value="${obj.proposer}"
                                                           disabled>
                                                    <input type="hidden" id="proposerId" value="${obj.proposerId}"
                                                           name="proposer">
                                                    <input type="hidden" value="${obj.id}" name="id">
                                                    <input type="hidden" name="lenderUnit" value="${obj.lenderUnit}">
                                                </div>
                                                <label for="entryNumber" class="col-sm-1 control-label">工号：</label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="entryNumber"
                                                           name="entryNumber"
                                                           value="${obj.entryNumber}" disabled>
                                                    <input type="hidden" name="entryNumber" value="${obj.entryNumber}">
                                                </div>
                                                <label for="phoneNumber" class="col-sm-1 control-label">联系电话：</label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="phoneNumber"
                                                           name="number"
                                                           value="${obj.phoneNumber}">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="lendDate" class="col-sm-1 control-label">借用日期：</label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="lendDate"
                                                           data-parsley-required="true" value="${@date.formatDate(obj.lendDate)}"
                                                           name="lendDate" disabled>
                                                    <input type="hidden" name="lendDate" value="${@date.formatDate(obj.lendDate)}">
                                                </div>

                                                <label for="returnDate" class="col-sm-1 control-label">归还日期：
                                                    <span class="font-red">*</span>
                                                </label>
                                                <div class="col-sm-2">
                                                    <input type="text" class="form-control" id="returnDate"
                                                           data-parsley-required="true"
                                                           name="returnDate">
                                                    <input type="hidden" name="returnDate" value="${@date.formatDate(obj.returnDate)}">
                                                </div>

                                                <label for="accessary" class="col-sm-1 control-label">附件：</label>
                                                <div class="col-sm-5">
                                                    <input type="text" class="form-control" id="accessary"
                                                           name="accessary" disabled
                                                           data-parsley-required="true" data-parsley-maxlength="200">
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label for="remark" class="col-sm-1 control-label">备注：</label>
                                                <div class="col-sm-5">
                                                    <input type="text" class="form-control" id="remark" name="remark"
                                                           data-parsley-required="true" data-parsley-maxlength="200">
                                                </div>
                                                <div class="col-sm-3 pull-right">
                                                    <button type="button" class="btn btn-danger" onclick="clearDelay()"
                                                            style="width:120px">请空
                                                    </button>
                                                    <button class="btn btn-primary btn_All ml_20"
                                                            data-loading-text="正在提交..."
                                                            style="width:120px">提交
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                                <div class="panel panel-primary">
                                    <div class="panel-heading" role="tab" id="headingThree">
                                        <h4 class="panel-title">
                                            <a role="button" data-toggle="collapse" data-parent="#accordion"
                                               href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                月历
                                            </a>
                                        </h4>
                                    </div>
                                    <div id="three" class="panel-collapse" role="tabpanel"
                                         aria-labelledby="headingFour">
                                        <div class="panel-body">
                                            <section class="date">
                                                <div class="head">
                                                    <div class="prev">上一月</div>
                                                    <div class="tomon"><span class="year"></span>年 <span
                                                            class="month"></span>月
                                                    </div>
                                                    <div class="next">下一月</div>
                                                </div>
                                                <ol>
                                                    <li>星期日</li>
                                                    <li>星期一</li>
                                                    <li>星期二</li>
                                                    <li>星期三</li>
                                                    <li>星期四</li>
                                                    <li>星期五</li>
                                                    <li>星期六</li>
                                                </ol>
                                                <ul class="tip_trigger">
                                                    <li>日期</li>
                                                    <li>日期</li>
                                                    <li>日期</li>
                                                    <li>日期</li>
                                                    <li>日期</li>
                                                    <li>日期</li>
                                                    <li>日期</li>
                                                    <li>日期</li>
                                                    <li>日期</li>
                                                    <li>日期</li>
                                                    <li>日期</li>
                                                </ul>
                                                <!--图例-->
                                                <div>
                                                    <div class="pull-right">
                                                        <div class="for_symbol"><h4 style="float: left">可以预约:</h4><span
                                                                class="circlew"></span></div>
                                                        <div class="for_symbol"><h4 style="float: left">我的预约:</h4><span
                                                                class="circleg"></span></div>
                                                        <div class="for_symbol"><h4 style="float: left">他人预约:</h4><span
                                                                class="circley"></span></div>
                                                        <div class="for_symbol"><h4 style="float: left">逾期未还:</h4><span
                                                                class="circler"></span></div>
                                                        <div class="for_symbol"><h4 style="float: left">不可预约:</h4><span
                                                                class="circleh"></span></div>
                                                    </div>
                                                </div>
                                                <div class="tip_show">
                                                    <p id="person">申请人：</p>
                                                    <p id="num">申请编号；</p>
                                                    <p id="phone">联系电话；</p>
                                                    <p id="to">借出日期：</p>
                                                    <p id="return">归还日期：</p>
                                                </div>
                                            </section>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
<a class="exit-offscreen"></a>
<script language="JavaScript">
    var myApps = "${myApply}";
    var otherApps = "${otherApply}";
    var forbidApps = "${forbid}";
    var delayApps = "${delayApply}";
    var forbidStart = "";
    var infoUrl = "${base}/asset/apply/sign/getCurrentInfo";
    $(function () {

        setDate2("lendDate", "returnDate");
        // 设置占用
        setColor();
        toolTips();
        setValue();
        subApply();
        $(".tomon, .prev, .next").click(function () {
            setColor();
            setValue();
        });

    });

    // 提交表单
    function subApply() {
        $('#applyDelayModal').ajaxForm({
            dataType: 'json',
            beforeSubmit: function (arr, form, options) {
                var lendDate = $("#lendDate").val();
                var returnDate = $("#returnDate").val();
                if (!checkBeforeSub(lendDate, returnDate)) {
                    return false;
                }
                form.find("button:submit").button("loading");
            },
            success: function (data, statusText, xhr, form) {
                if (data.code == 0) {
                    Toast.success(data.msg);
                    setTimeout(function () {
                        window.location.href = "${base}/asset/apply/mine";
                    }, 1000);
                } else {
                    if ("没有权限" != data.msg) {
                        Toast.error(data.msg);
                    }
                }
                form.find("button:submit").button("reset");
            }
        });
    }

    // 校验提交日期是否冲突
    function checkOverlap() {
        var symbol = $.ajax({
            type: "post",
            url: "${base}/asset/apply/sign/checkOverlap",
            data: {
                lendDate: $("#lendDate").val(),
                returnDate: $("#returnDate").val(),
                assetCode: $("#assetCode").val()
            },
            dataType: "json",
            async: false,
            success: function (data) {
                if (data.code == 0) {
                    return true;
                } else {
                    return false;
                }
            }
        });
        var temp = symbol.responseJSON;
        if (temp.code == 1) {
            return false;
        } else {
            return true;
        }
    }

    // 校验
    function checkBeforeSub(lendDate, returnDate) {
        if (lendDate == "" || returnDate == "") {
            Toast.error("请先选择需要借用归还的日期！");
            return false;
        }
        var lend = new Date(lendDate).getTime();
        var retu = new Date(returnDate).getTime();
        if (lendDate != "" && returnDate != "" && lend > retu) {
            Toast.error("归还日期不能小于借用日期！");
            return false;
        }
        // 如果有禁用
        var forbid = forbidApps.split(",")[0];
        if (forbid != 0) {
            var fo = new Date(forbid).getTime();
            if (lend >= fo || retu >= fo) {
                Toast.error("借用归还日期不能与禁用日期有重叠！");
                return false;
            }
        }
        if (!checkOverlap()) {
            Toast.error("当前选择的延期日期与已有申请日期有重叠，请重新选择！");
            return false;
        }
        // 预约时长不能超过30天
        if ((retu - lend) / 1000 >= 2592000) {
            Toast.error("申请延期的最长时间不能超过30天,请重新选择!");
            return false;
        }
        if (!theOtherChecks()) {
            return false;
        }
        return true;
    }

    // 电话号码,附件、备注长度
    function theOtherChecks() {
        var regx = /^1[3|4|5|7|8][0-9]\d{8}$/;
        var number = $("#phoneNumber").val();
        var remark = $("#remark").val();
        var accessary = $("#accessary").val();
        if (accessary.length > 200) {
            Toast.error("附件最多允许输入200个字符!");
            return false;
        }
        if (remark.length > 200) {
            Toast.error("备注最多允许输入200个字符!");
            return false;
        }
        if (number != "" && !regx.test(number)) {
            Toast.error("请填写正确的手机号码");
            return false;
        }
        return true;
    }

    // 请空
    function clearDelay() {
        $("#phoneNumber").val("");
        $("#returnDate").val("");
        $("#remark").val("");
    }

</script>

<%}%>